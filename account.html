<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>DevCircle - Account Settings</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <h1 id="welcome">Account Settings</h1>
    </header>
    <div class="center-box">
        <a href="main.html" class="back-link">&larr; Back to Main</a>
        <div class="profile-preview" id="profilePreview"></div>
        <form class="settings-form" id="settingsForm">
            <label for="username">Username</label>
            <input type="text" id="username" required>

            <label for="pfp">Profile Picture</label>
            <input type="file" id="pfp" accept="image/*">

            <button type="submit">Save Changes</button>
        </form>
        <button id="logoutBtn" style="margin-top:20px;">Logout</button>
        <div id="settingsMessage"></div>
    </div>
    <footer>
        <p>&copy; 2024 DevCircle. All rights reserved.</p>
    </footer>
    <script>
        const token = localStorage.getItem('token');
        let user = JSON.parse(localStorage.getItem('user') || 'null');
        if (!token || !user) window.location.href = 'login.html';

        // Show profile preview
        const profilePreview = document.getElementById('profilePreview');
        function updatePreview() {
            profilePreview.innerHTML = '';
            if (user.pfp) {
                const img = document.createElement('img');
                img.src = user.pfp;
                img.alt = "Profile";
                profilePreview.appendChild(img);
            } else {
                const span = document.createElement('span');
                span.className = "profile-initial";
                span.textContent = user.username ? user.username[0].toUpperCase() : "?";
                profilePreview.appendChild(span);
            }
        }
        updatePreview();

        document.getElementById('username').value = user.username;

        document.getElementById('settingsForm').onsubmit = async function (e) {
            e.preventDefault();
            const newUsername = document.getElementById('username').value.trim();
            let pfp = user.pfp;
            const fileInput = document.getElementById('pfp');
            if (fileInput.files && fileInput.files[0]) {
                pfp = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = function (evt) {
                        resolve(evt.target.result);
                    };
                    reader.readAsDataURL(fileInput.files[0]);
                });
            }
            const res = await fetch('http://localhost:3000/api/profile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ username: newUsername, pfp })
            });
            const data = await res.json();
            if (data.success) {
                user = data.user;
                localStorage.setItem('user', JSON.stringify(user));
                updatePreview();
                document.getElementById('settingsMessage').textContent = "Profile updated!";
                document.getElementById('settingsMessage').style.color = "green";
            } else {
                document.getElementById('settingsMessage').textContent = "Update failed.";
                document.getElementById('settingsMessage').style.color = "red";
            }
        };

        document.getElementById('logoutBtn').onclick = function () {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        };

        document.getElementById('pfp').onchange = function () {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function (evt) {
                    profilePreview.innerHTML = '';
                    const img = document.createElement('img');
                    img.src = evt.target.result;
                    img.alt = "Profile";
                    profilePreview.appendChild(img);
                };
                reader.readAsDataURL(this.files[0]);
            } else {
                updatePreview();
            }
        };
    </script>
</body>

</html>